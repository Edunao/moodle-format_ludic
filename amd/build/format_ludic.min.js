define(["jquery","jqueryui","core/templates","core/log"],function($,ui,templates,log){let ludic={init:function(params){ludic.courseId=params.courseid;ludic.sectionId=params.sectionid;ludic.userId=params.userid;ludic.editMode=params.editmode;ludic.editSkins=window.location.href.indexOf("ludic/edit_skins.php")>-1;$("body.format-ludic").prepend('<div id="ludic-background"></div>');ludic.initEvents();ludic.initAvatar("");if(ludic.editSkins){ludic.displaySkinsList()}if(!ludic.editSkins&&ludic.editMode){ludic.displaySections()}},initEvents:function(){ludic.initLudicActionEvent();if(ludic.editMode){ludic.initEditModeEvents()}},initLudicActionEvent:function(){$("body.format-ludic.path-course-view, body.format-ludic #ludic-header-bar, #page-course-format-ludic-edit_skins").on("click","[data-action]",function(e){if(!$(this).is(e.target)){if($(e.target).hasClass("no-ludic-event")||$(e.target).parents(".no-ludic-event").length>0||$(e.target).parents(".no-ludic-event").length>0&&$(e.target).data("action")===undefined){return false}}let item=$(this);let action=item.data("action");let callback=item.data("callback");let controller=item.data("controller");let params={item:item,id:item.data("id")?item.data("id"):null,selectorId:item.data("selectorid")?item.data("selectorid"):null,type:item.data("type")?item.data("type"):null,itemId:item.data("itemid")?item.data("itemid"):null,itemType:item.data("itemtype")?item.data("itemtype"):null,callback:callback};let skindata={};if(action=="avatar_toggle_item"||action=="avatar_buy_item"){skindata.slotname=item.data("slotname")?item.data("slotname"):null;skindata.itemname=item.data("itemname")?item.data("itemname"):null;skindata.sectionid=item.data("sectionid")?item.data("sectionid"):null;params.selectorId=item.data("sectionid")?'.item[data-id="'+item.data("sectionid")+'"] .item-content-container':null;params.id=item.data("sectionid")?item.data("sectionid"):null}let hasItemSelectorId=params.itemType&&params.itemId;params.itemSelectorId=hasItemSelectorId?".item."+params.itemType+'[data-id="'+params.itemId+'"]':null;if(controller&&action){ludic.ajaxCall({controller:controller,action:action,id:params.id?params.id:params.itemId,skindata:skindata,callback:function(response){if(callback){let isHtml=/<\/?[a-z][\s\S]*>/i.test(response);let responseParams=isHtml?{html:response}:response;responseParams=typeof params==="object"?responseParams:JSON.parse(responseParams);params=Object.assign(params,responseParams);ludic.callFunction(callback,params)}}})}else if(action){ludic.callFunction(action,params)}})},callFunction:function(name,params={}){let html=params.html?params.html:null;let callback=params.callback?params.callback:null;let id=params.id?params.id:null;let item=params.item?params.item:null;let itemId=params.itemId?params.itemId:null;let itemType=params.itemType?params.itemType:null;let itemSelectorId=params.itemSelectorId?params.itemSelectorId:null;let result=false;switch(name){case"displayCourseModulesHtml":case"displayPopup":case"displaySections":case"displaySkinTypesForm":case"displaySkinTypesHtml":result=eval("ludic."+name+"(html, callback)");break;case"displayProperties":result=ludic.displayProperties(itemId);break;case"saveForm":result=ludic.saveForm(itemType,itemId);break;case"revertForm":result=ludic.revertForm(itemSelectorId);break;case"updateAvatar":result=ludic.updateAvatar(params.selectorId,id,html);break;case"displayCourseModules":result=ludic.displayCourseModules(id,itemId,callback);break;case"open-chooser":result=ludic.openModChooser(item);break;default:result=eval("ludic."+name+"(item)");return result}return result},ajaxCall:function(params){let that=this;params.courseid=ludic.courseId;params.userid=ludic.userId;let dataType=params.dataType?params.dataType:"html";let method=params.method?params.method:"GET";let url=params.url?params.url:M.cfg.wwwroot+"/course/format/ludic/ajax/ajax.php";let async=params.async?params.async:true;let callback=params.callback?params.callback:null;let callbackError=params.error?params.error:null;let loading=params.loading?params.loading:null;if(loading){ludic.addLoading(loading)}delete params.dataType;delete params.method;delete params.url;delete params.async;delete params.callback;delete params.loading;if(params.skindata!==undefined){params=$.extend(params,params.skindata);delete params.skindata}$.ajax({method:method,url:url,data:params,dataType:dataType,async:async,error:function(jqXHR,error,errorThrown){if(typeof callbackError==="function"){callbackError(jqXHR,error,errorThrown)}else if(jqXHR.responseText.length>0&&jqXHR.responseText.indexOf("pagelayout-login")!==-1){that.redirectLogin()}else{that.displayErrorPopup()}}}).done(function(response){if(response.length>0&&response.indexOf("pagelayout-login")!==-1){that.redirectLogin()}if(typeof callback==="function"){callback(response)}})},initItemGetPropertiesEvent:function(){$("body.format-ludic").on("click",".container-items .container-parents .item",function(){let itemid=$(this).attr("id");if($(this).closest(".format-ludic.ludic-popup").length===0&&ludic.formChanged){ludic.displayChoicePopup("confirmation","displayProperties",{title:M.util.get_string("confirmation-form-exit-title","format_ludic"),content:M.util.get_string("confirmation-form-exit-content","format_ludic"),itemid:itemid})}else{ludic.displayProperties(itemid)}})},toggleFilepicker:function(element){element.parent(".ludic-form-group").find(".ludic-filepicker-container").toggle()},editSkinDeleteStep:function(element){ludic.setFormChanged(true);let itemid=element.data("itemid");$(".ludic-form-group."+itemid+", .ludic-form-separator."+itemid).remove();element.remove()},displayProperties:function(itemid){let item=$("#"+itemid);let container=item.closest(".container-items");container.find(".item.selected").removeClass("selected");container.find(".item.pre-selected").removeClass("pre-selected");item.addClass("selected");let id=item.data("id");let type=item.data("type");let action=item.data("propertiesaction");if(!id||!type||!action){return false}let content=container.find(".container-properties .container-content");ludic.addLoading(content);ludic.ajaxCall({id:id,controller:type,action:action,callback:function(html){content.html(html);ludic.initFilepickerComponent(container);ludic.setFormChanged(false);if(item.closest(".format-ludic.ludic-popup").length===0){ludic.closeClosestPopup()}}})},initAvatar:function(selector){$(selector+" .skin-type-avatar .open-inventory").on("click",function(){let inventoryid=$(this).attr("class").split(" open-inventory-")[1];inventoryid=inventoryid.split(" ")[0];$("#avatar-inventory-"+inventoryid).modal("show")});$(selector+" .skin-type-avatar .open-inventory").each(function(){let inventoryid=$(this).attr("class").split(" open-inventory-")[1];inventoryid=inventoryid.split(" ")[0];$("#avatar-inventory-"+inventoryid+" .avatar-preview").html($("#skin-section-"+inventoryid+" .skin-tile").prop("outerHTML"));$("#avatar-inventory-"+inventoryid+" .avatar-preview .open-inventory").remove()})},updateAvatar:function(selectorId,sectionid,html){selectorId=".section"+selectorId;$("#avatar-inventory-"+sectionid).modal("hide");$(selectorId).each(function(){$(this).html(html)});$(".header-sections-list "+selectorId+" .skin-extra-html").remove();this.initAvatar(selectorId);$("#avatar-inventory-"+sectionid).modal("show");let scrollvalue=$("#avatar-inventory-"+sectionid+" .slot-item.selected").position().top;$("#avatar-inventory-"+sectionid+" .inventory-content").animate({scrollTop:scrollvalue-30},0)},initFormEvents:function(){let body=$("body.format-ludic");body.on("click","#selection-popup .item",function(){$("#selection-popup .confirmation-button.confirm").data("value",$(this).data("id"))});body.on("change",".ludic-form :input",function(){if(!ludic.formChanged){ludic.setFormChanged(true)}});body.on("change",'.ludic-form-group[data-type="select"] select',function(){let descriptionContainer=$(this).parent().find(".select-description");if(!descriptionContainer){return}descriptionContainer.find(".option-description").removeClass("visible");descriptionContainer.find('.option-description[for="'+$(this).val()+'"]').addClass("visible")})},initSelectedEvents:function(){let body=$("body.format-ludic");body.on("DOMNodeInserted",function(e){let selectedItem=$(e.target).find(".item.selected").addBack(".item.selected");if(selectedItem.length){selectedItem.click()}});body.on("click",".container-children .item.child",function(){let parentId=$(this).data("parentid");let parent=$('.container-parents .item.parent[data-id="'+parentId+'"]');$(".container-parents .item").removeClass("pre-selected");parent.addClass("pre-selected")})},revertForm(itemSelectorId){ludic.displayProperties($(itemSelectorId).attr("id"))},saveForm:function(itemType,itemId){let formSelector="#ludic-form-"+itemType+"-"+itemId;let form=$(formSelector);let serialize=form.serializeArray();let container=form.parent().find(".container-success");ludic.addLoading(container);ludic.ajaxCall({controller:itemType,id:itemId,data:serialize,dataType:"json",action:"validate_form",callback:function(json){let newClass=json.success?"success":"error";let unwantedClass=json.success?"error":"success";container.html(json.value);container.removeClass(unwantedClass);container.addClass(newClass);ludic.setFormChanged(false);let updateFunction=false;let params={};if(itemType==="section"){updateFunction="displaySections";params.callback=function(){$(".item."+itemType+'[data-id="'+itemId+'"]').addClass("selected");ludic.displayCourseModules(itemId)}}else if(itemType==="coursemodule"){updateFunction="displayCourseModules";params.callback=function(){if($(".item."+itemType+'[data-id="'+itemId+'"]').length===0){$('.item.section[data-id="'+params.id+'"]').trigger("click")}else{$(".item."+itemType+'[data-id="'+itemId+'"]').addClass("selected")}};params.id=$(".item."+itemType+'[data-id="'+itemId+'"]').data("parentid");params.itemId=itemId}else if(itemType==="skin"){let skintype=json.skintype;$('.item.skin[data-id="'+skintype+'"]').trigger("click");return}if(updateFunction){ludic.callFunction(updateFunction,params)}}})},showSubButtons:function(button){$(button).removeClass("show-sub-buttons");$(button).addClass("hide-sub-buttons");$(button).data("action","hideSubButtons");let icon=$(button).find("i");if(icon.length){icon.addClass("fa-minus-square");icon.removeClass("fa-plus-square")}let identifier=$(button).data("identifier");let subButtons=$('.container-sub-buttons[for="'+identifier+'"]');subButtons.outerWidth($(button).outerWidth());subButtons.css("top",$(button).position().top+$(button).outerHeight());subButtons.removeClass("hide")},hideSubButtons:function(button){$(button).removeClass("hide-sub-buttons");$(button).addClass("show-sub-buttons");$(button).data("action","showSubButtons");let icon=$(button).find("i");if(icon.length){icon.removeClass("fa-minus-square");icon.addClass("fa-plus-square")}let identifier=$(button).data("identifier");let subButtons=$('.container-sub-buttons[for="'+identifier+'"]');subButtons.addClass("hide")},getDataLinkAndRedirectTo:function(item){let url=$(item).data("link");ludic.redirectTo(url)},confirmAndDeleteSection:function(section){let context={itemid:$(section).data("itemid")?$(section).data("itemid"):null,link:$(section).data("link")?$(section).data("link"):null};ludic.displayChoicePopup("confirmation-popup","deleteSection",context)},deleteSection:function(section){let id=$(section).data("itemid");let link=$(section).data("link");if(!id||!link){return}ludic.ajaxCall({controller:"section",action:"delete_section_skin_id",id:id,callback:function(){ludic.redirectTo(link)}})},confirmAndDeleteCourseModule:function(coursemodule){let context={itemid:$(coursemodule).data("itemid")?$(coursemodule).data("itemid"):null,link:$(coursemodule).data("link")?$(coursemodule).data("link"):null};ludic.displayChoicePopup("confirmation-popup","deleteCourseModule",context)},deleteCourseModule:function(coursemodule){let id=$(coursemodule).data("itemid");let link=$(coursemodule).data("link");if(!id||!link){return}ludic.ajaxCall({controller:"coursemodule",action:"delete_format_ludic_cm",id:id,callback:function(){ludic.redirectTo(link)}})},confirmAndDeleteSkin:function(skin){let context={itemid:$(skin).data("itemid")?$(skin).data("itemid"):null,courseid:$(skin).data("courseid")?$(skin).data("courseid"):null};ludic.displayChoicePopup("confirmation-popup","deleteSkin",context)},deleteSkin:function(skin){let skinid=$(skin).data("itemid");let courseid=$(skin).data("courseid");ludic.ajaxCall({controller:"skin",action:"delete_skin",id:skinid,courseid:courseid,callback:function(json){json=$.parseJSON(json);let skintype=json.skintype;$('.item.skin[data-id="'+skintype+'"]').trigger("click")}})},selectAndUpdateInput:function(selectionPopup){let inputSelectorId="#"+$(selectionPopup).data("selectorid");let inputValue=$(inputSelectorId).val();let itemController=$(selectionPopup).data("itemcontroller")?$(selectionPopup).data("itemcontroller"):null;let itemAction=$(selectionPopup).data("itemaction")?$(selectionPopup).data("itemaction"):null;let title=$(selectionPopup).data("title")?$(selectionPopup).data("title"):null;let itemId=$(selectionPopup).data("itemid")?$(selectionPopup).data("itemid"):null;if(!itemAction||!itemController){return false}ludic.ajaxCall({controller:itemController,action:itemAction,selectedid:inputValue,itemid:itemId,callback:function(content){let context={selectorid:inputSelectorId,title:title,content:content};ludic.displayChoicePopup("selection-popup","updateInputAfterSelect",context)}})},updateInputAfterSelect:function(){let popup=$("#selection-popup");let inputSelectorId=popup.attr("for");let selectedItem=popup.find(".container-parents .item.selected");let newValue=selectedItem.data("id");$(inputSelectorId).val(newValue);ludic.setFormChanged(true);let newImgUrl=selectedItem.find(".item-img-container").attr("style");if(newImgUrl){$(inputSelectorId+"-overview .overview-img-container").attr("style",newImgUrl)}ludic.closeClosestPopup(popup);$("button.form-save").click()},initEditModeEvents:function(){ludic.initItemGetPropertiesEvent();ludic.initFormEvents();ludic.initSaveLastItemClickedEvents();ludic.initSelectedEvents()},closeClosestPopup:function(item){if(item){let popup=$(item).closest(".format-ludic.ludic-popup");$(popup).remove()}else{$(".format-ludic.ludic-popup").remove()}if($(".format-ludic.ludic-popup").length===0){$("#ludic-background").hide()}},initSaveLastItemClickedEvents:function(){let lastTimeStamp=0;let getClassListSelector=function(classList){classList=classList!==undefined?classList.replace(" is-not-visible",""):"";classList=classList.replace(" selected","");return classList?"."+$.trim(classList).replace(/\s/gi,"."):""};$("#ludic-main-container .container-parents").on("click",".item",function(e){if(!e.hasOwnProperty("originalEvent")){return}let eventTimeStamp=e.timeStamp;if(lastTimeStamp!==eventTimeStamp){lastTimeStamp=eventTimeStamp}else{return}let tree=[this];$(this).parentsUntil(".course-content").each(function(id,item){tree[id+1]=item});let selector="";$(tree).each(function(){let currentId=$(this).attr("id");let selectorId=currentId&&currentId.indexOf("yui_")===-1?"#"+currentId:"";let currentSelector=" > "+this.tagName+selectorId+getClassListSelector($(this).attr("class"));selector=currentSelector+selector});selector=selector.substring(3);if(selector){sessionStorage.setItem("lastClick",selector)}})},clickOnLastItemClicked:function(){let anchor=window.location.hash.substr(1);let section=ludic.getUrlParam("section",window.location.href);if(section!==null){anchor="section-"+section}let lastCLick="#ludic-"+anchor;if(lastCLick==="#ludic-section-0"){anchor="childHasBeenAdded"}history.replaceState(null,null," ");if(!anchor||anchor==="childHasBeenAdded"){lastCLick=sessionStorage.getItem("lastClick")}let selectdefault=false;if(!lastCLick){selectdefault=true;lastCLick=".container-parents > .item.section-0"}$(lastCLick).click();if(!selectdefault){let interval=setInterval(function(){let children=$(".container-items .container-children .item");let lastItemClicked=$(lastCLick);if(lastCLick.search(".container-children")&&children.length===0){let regex=".parent-id-([0-9]+)";let parentId=lastCLick.match(regex)!==null?lastCLick.match(regex)[1]:false;if(parentId){$('.container-parents .item[data-id="'+parentId+'"]').click()}}if(lastItemClicked.length>0){if(lastItemClicked.hasClass("parent")){if(children.length===0){lastItemClicked.click()}}else{lastItemClicked.click()}if(anchor==="childHasBeenAdded"){if(children.length>0){children.last().click();clearInterval(interval)}}else{clearInterval(interval)}}},500)}},initModuleDragDrop:function(){$(".container-children.coursemodules .children-elements").sortable({items:".ludic-drag",update:function(event,ui){let cmid=ui.item.data("id");ludic.ajaxCall({cmid:cmid,newindex:$(".container-children.coursemodules .children-elements .ludic-drag").index(ui.item),controller:"section",action:"update_cm_order",callback:ludic.displayCourseModulesHtml})}})},initSectionDragDrop:function(){$(".ludic-container.container-parents").sortable({items:".item.section.ludic-drag",update:function(event,ui){let sectionid=ui.item.data("id");ludic.ajaxCall({sectionid:sectionid,newindex:$(".ludic-container.container-parents .item.section").index(ui.item),controller:"section",action:"update_section_order",callback:ludic.displaySections})}})},initFilepickerComponent:function(container){let filepickers=container.find(".ludic-filepicker-container");if(filepickers.length===0){return}filepickers.each(function(){let options=$(this).data("options");M.form_filepicker.init(Y,options);$(this).removeAttr("data-options")})},displayCourseModules:function(sectionId,courseModuleId,callback){ludic.ajaxCall({controller:"section",action:"get_course_modules",id:sectionId,selectedid:courseModuleId,callback:function(html){ludic.displayCourseModulesHtml(html,callback)}})},displayCourseModulesHtml:function(html,callback){let container=$(".container-children.coursemodules .children-elements");if(!ludic.editMode){container.html(html);if(typeof callback==="function"){callback(container.html())}return}ludic.initModuleDragDrop();let userConfirmation=setInterval(function(){if(ludic.formChanged){return}ludic.addLoading(container);let modChooser=$(html).closest(".ludic-modchooser");if(modChooser.length===0){container.html(html);return}$(html).each(function(){let hiddenDiv=$(this).addClass("hide-js");container.append(hiddenDiv)});$(".section-modchooser").hide();let interval=setInterval(function(){if(typeof M.course.init_chooser==="function"){M.course.init_chooser({courseid:ludic.courseId,closeButtonTitle:undefined});container.children().each(function(){$(this).removeClass("hide-js")});if(typeof callback==="function"){callback(container.html())}ludic.removeLoading(container);clearInterval(interval)}},1e3);clearInterval(userConfirmation)},100)},redirectLogin:function(){window.location.href=M.cfg.wwwroot+"/login/index.php"},redirectTo:function(url){window.location.href=url},reload:function(){window.location.reload()},displayPopup:function(html){let selectorId="#"+$(html).attr("id");$(selectorId).remove();$("body").append(html);$(selectorId).modal("show")},displayErrorPopup:function(){let context={popupid:"error",action:"reload",title:M.util.get_string("error-popup-title","format_ludic"),content:M.util.get_string("error-popup-content","format_ludic")};templates.render("format_ludic/popup_confirm",context).then(function(html){ludic.displayPopup(html)}).fail(function(){ludic.reload()})},displayChoicePopup:function(popupid,action,params){let context={popupid:popupid,action:action,link:params.link?params.link:null,itemid:params.itemid?params.itemid:null,selectorid:params.selectorid?params.selectorid:null,value:params.value?params.value:null,title:params.title?params.title:M.util.get_string("confirmation-popup-title","format_ludic"),content:params.content?params.content:M.util.get_string("confirmation-popup-content","format_ludic")};templates.render("format_ludic/popup_confirm",context).then(function(html){ludic.displayPopup(html)}).fail(function(){ludic.displayErrorPopup()})},displaySkinTypesHtml:function(html,callback){let container=$(".edit-skins-view > .container-items > .container-parents .skin-types-list > .children-elements");if(html){ludic.addLoading(container);container.html(html);if(typeof callback==="function"){callback(html)}}},displaySkinTypesForm:function(html,callback){let container=$(".edit-skins-view .container-properties .container-content");if(html){ludic.addLoading(container);container.html(html);ludic.initFilepickerComponent(container);if(typeof callback==="function"){callback(html)}}},displaySections:function(html,callback){let container=$(".container-items .container-parents");if(html){ludic.addLoading(container);container.html(html);if(typeof callback==="function"){callback(html)}}else{ludic.ajaxCall({controller:"section",action:"get_course_sections",loading:container,callback:function(response){container.html(response);ludic.clickOnLastItemClicked();if(typeof callback==="function"){callback(response)}}})}ludic.initSectionDragDrop()},displaySkinsList:function(html,callback){let container=$(".edit-skins-view > .container-items > .container-parents > .children-elements");if(html){ludic.addLoading(container);container.html(html);if(typeof callback==="function"){callback(html)}}else{ludic.ajaxCall({controller:"skin",action:"get_course_skins_list",loading:container,callback:function(response){container.html(response);if(typeof callback==="function"){callback(response)}}})}},openModChooser:function(element){let sectionid=element.data("section");$("#section-"+sectionid+".ludic-modchooser .section-modchooser-link .section-modchooser-text").trigger("click")},addLoading:function(parent){parent.html('<div class="loading"></div>')},removeLoading:function(parent){parent.find(".loading").remove()},setFormChanged:function(value){ludic.formChanged=value;let buttons=$(".container-buttons button:not(.form-save):not(.form-revert)");buttons.each(function(id,button){let hasDataAction=$(button).data("action")!==undefined;let disabled=ludic.formChanged;if(!hasDataAction){disabled=true}$(button).attr("disabled",disabled)})},getUrlParam:function(name,url){var results=new RegExp("[?&]"+name+"=([^&#]*)").exec(url);if(results===null){return null}return decodeURI(results[1])||0}};return ludic});